---
import { t } from '../i18n/utils';
import type { Language } from '../i18n/utils';

interface Props {
  title?: string;
  description?: string;
  lang?: Language;
}

// 获取语言的辅助函数
function getLanguage(cookies: AstroCookies, url: URL): Language {
  // 先检查 URL 参数
  const urlLang = url.searchParams.get('lang');
  if (urlLang === 'zh' || urlLang === 'en') {
    return urlLang as Language;
  }

  // 再检查 cookie
  const langCookie = cookies.get('lang');
  if (langCookie?.value === 'zh' || langCookie?.value === 'en') {
    return langCookie.value as Language;
  }

  return 'zh';
}

const {
  title,
  description,
  lang = getLanguage(Astro.cookies, Astro.url),
} = Astro.props;

// 使用多语言标题和描述
const siteTitle = title || t(lang, 'siteTitle');
const siteDescription = description || t(lang, 'siteDescription');

// 从 Astro.cookies 获取主题偏好
const themeCookie = Astro.cookies.get('theme');
function getTheme() {
  if (themeCookie?.value) {
    return themeCookie.value === 'dark' ? 'dark' : '';
  }
  // 如果没有 cookie，检查系统偏好
  const prefersDark = Astro.request.headers.get('sec-ch-prefers-color-scheme');
  return prefersDark === 'dark' ? 'dark' : '';
}

const themeClass = getTheme();
---

<!doctype html>
<html lang={lang === 'en' ? 'en' : 'zh-CN'} class={`scroll-smooth ${themeClass}`}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={siteDescription} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" href="/favicon.ico" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <title>{siteTitle}</title>
  </head>
  <body class="bg-white dark:bg-neutral-950 text-neutral-900 dark:text-neutral-100 antialiased transition-colors duration-200">
    <slot />
  </body>
</html>

<style is:global>
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --border: 0 0% 89.8%;
  }

  .dark {
    --background: 240 10% 3.9%;
    --foreground: 0 0% 98%;
    --card: 240 10% 3.9%;
    --card-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 240 5.9% 10%;
    --muted: 240 3.7% 15.9%;
    --muted-foreground: 240 5% 64.9%;
    --border: 240 3.7% 15.9%;
  }
</style>
